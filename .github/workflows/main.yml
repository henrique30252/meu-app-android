name: Build Android APK
on: 
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite executar manualmente

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ☕ Set up Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'
        
    - name: 📦 Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
        
    - name: 🔧 Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git zip unzip openjdk-8-jdk \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake libffi-dev libssl-dev \
          build-essential libltdl-dev
        
    - name: 🐍 Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython kivy
        
    - name: 🔍 Verify installations
      run: |
        echo "Python version:"
        python --version
        echo "Java version:"
        java -version
        echo "JAVA_HOME:"
        echo $JAVA_HOME
        echo "Buildozer version:"
        buildozer --version
        
    - name: 📱 Build APK
      run: |
        echo "🚀 Starting APK build..."
        buildozer android debug
        
    - name: 📋 List generated files
      run: |
        echo "Generated files:"
        find . -name "*.apk" -type f
        ls -la bin/ || echo "No bin directory found"
        
    - name: 📤 Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: 📊 Build summary
      run: |
        if [ -f bin/*.apk ]; then
          echo "✅ APK build successful!"
          echo "📱 APK location: bin/"
          ls -lh bin/*.apk
        else
          echo "❌ APK build failed!"
          exit 1
        fi
